<!DOCTYPE html>
<html lang="zh" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>让Adb.exe支持Monkey - 雪山</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <link href="/images/favicon.png" rel="icon">

<link rel="canonical" href="/adb-support-monkey.html">

        <meta name="author" content="雪山" />
        <meta name="keywords" content="Android,adb,技术,monkey" />
        <meta name="description" content="让Adb.exe支持Monkey。这一篇主要讲如果让我自己的adb.exe支持monkey调试功能呢？" />

        <meta property="og:site_name" content="雪山" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="让Adb.exe支持Monkey"/>
        <meta property="og:url" content="/adb-support-monkey.html"/>
        <meta property="og:description" content="让Adb.exe支持Monkey。这一篇主要讲如果让我自己的adb.exe支持monkey调试功能呢？"/>
        <meta property="article:published_time" content="2015-09-27" />
            <meta property="article:section" content="Android" />
            <meta property="article:tag" content="Android" />
            <meta property="article:tag" content="adb" />
            <meta property="article:tag" content="技术" />
            <meta property="article:tag" content="monkey" />
            <meta property="article:author" content="雪山" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="/theme/css/style.css" type="text/css"/>





    <!-- baidu Statistics -->
	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "https://hm.baidu.com/hm.js?a7cd0e317621471e586bf369894135aa";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>


</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="/" class="navbar-brand">
<img class="img-responsive pull-left gap-right" src="/images/favicon.png" width="24"/> 雪山            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li class="active">
                            <a href="/category/android.html">Android</a>
                        </li>
                        <li >
                            <a href="/category/ji-zhu.html">技术</a>
                        </li>
                        <li >
                            <a href="/category/liang-hua.html">量化</a>
                        </li>
                        <li >
                            <a href="/category/ri-chang.html">日常</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="/adb-support-monkey.html"
                       rel="bookmark"
                       title="Permalink to 让Adb.exe支持Monkey">
                        让Adb.exe支持Monkey
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2015-09-27T22:27:00+08:00"> 日 27 九月 2015</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="/tag/android.html">Android</a>
        /
	<a href="/tag/adb.html">adb</a>
        /
	<a href="/tag/ji-zhu.html">技术</a>
        /
	<a href="/tag/monkey.html">monkey</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <blockquote>
<p>最近老研究一些之前的东西，越来越怀旧了真是</p>
</blockquote>
<h1><strong>下载源码</strong></h1>
<p>要改造adb.exe从思路来讲很简单，把android源码里面的adb.exe部分提取出来，改造再进行编译不就可以了？是的。但是这一块的源码在哪个模块呢？由哪些文件构成？我是不是要先下载所有的Android源码才找得到？现在google的网站被封？我还得先...... 技术就是这样，思路很简单的事情操作起来可能并不简单，需要大把的时间，这里给大家介绍一个资源</p>
<blockquote>
<p>android源码查找，可以根据文件名，类名，方法名的定义去查找到相应的文件(<a href="http://osxr.org/android/ident?">http://osxr.org/android/ident?</a>)(Ver: 4.1.2_r2)</p>
</blockquote>
<p>有了该网站，就可以不用下载整个android源码了，但是我还是把一整套android源码下下来了，整个过程太过艰辛，感叹一下做技术人员不容易，和各种势力进行抗争啊真是。经过一番查找，下面为adb client所在的源码目录</p>
<blockquote>
<p>http://osxr.org/android/source/system/core/adb/</p>
</blockquote>
<p>到了这里，是不是要去找一些官方文档，该目录下的一些文档说明来进行编译，太纠结了，去github上找找吧，现在是共享时代</p>
<blockquote>
<p>https://github.com/t-mat/my_adb</p>
</blockquote>
<p>啰嗦了一堆，其实就是下载my_adb去进行改造，不要打我</p>
<h1><strong>对源码进行改造</strong></h1>
<h2><strong>源码结构 </strong></h2>
<div class="highlight"><pre><span></span><span class="c1">//入口 adb.c</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
 <span class="p">{</span>
 <span class="cp">#if ADB_HOST</span>
     <span class="n">adb_sysdeps_init</span><span class="p">();</span>
     <span class="n">adb_trace_init</span><span class="p">();</span>
     <span class="n">D</span><span class="p">(</span><span class="s">&quot;Handling commandline()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
     <span class="k">return</span> <span class="n">adb_commandline</span><span class="p">(</span><span class="n">argc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">argv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#else</span>
    <span class="k">if</span><span class="p">((</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&quot;recovery&quot;</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">adb_device_banner</span> <span class="o">=</span> <span class="s">&quot;recovery&quot;</span><span class="p">;</span>
        <span class="n">recovery_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">start_device_log</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">adb_main</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DEFAULT_ADB_PORT</span><span class="p">);</span>
<span class="cp">#endif</span>
 <span class="p">}</span>
</pre></div>


<p>我们执行adb.exe时，会进入到if ture里面的分支，进入到adb_commondline函数</p>
<div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">adb_commandline</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;devices&quot;</span><span class="p">))</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
        <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="s">&quot;host:%s&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">adb_query</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;List of devices attached </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;connect&quot;</span><span class="p">))</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Usage: adb connect &lt;host&gt;[:&lt;port&gt;]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="s">&quot;host:connect:%s&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">adb_query</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>


<p>该函数里面的功能就是常规的解析命令行参数，然后执行对应的功能，上面的代码展示出来的是常见的两个功能，显示设备列表和连接到某台设备</p>
<p>OK，不往下分析了，先分析一下我们需要加的功能吧</p>
<h2><strong>需要改造的功能</strong></h2>
<p>通过上一篇文章的分析可以得出有两个功能需要改进：<strong>adb.exe中无法传送utf-8格式字符串的问题</strong> 和 <strong>增加传送monkey指令的功能</strong></p>
<h3><strong>adb.exe中无法传送utf-8格式字符串的问题</strong></h3>
<p>该问题网上是有现成的解决方案的，思路上只需要在发送buffer的时候，把gbk转成utf-8即可，adb daemon 是识别utf-8格式的，所以原生的adb传送gbk格式，中文就会显示不出来。
cmd默认字符编码是gbk，而且vs2013里面默认的文件编码也是gbk，如果把vs2013里面的源码文件改成utf-8格式的，是否可以不更改adb的源码，就可以用？我没试过，有兴趣的朋友可以测试一下，从原理上来讲是可以的。</p>
<h3><strong>增加传送monkey指令的功能</strong></h3>
<p>这个功能是需要和本地的adb server进行TCP交互的，还记得上一篇文章的图吗？</p>
<p><img alt="adb结构图" src="http://img.blog.csdn.net/20150927214857126"></p>
<p>执行monkey命令流程流程是这样的，一次连接可能会执行很多次命令</p>
<div class="highlight"><pre><span></span><span class="nt">st</span><span class="o">=&gt;</span><span class="nt">start</span><span class="o">:</span> <span class="err">连接</span><span class="nt">Monkey</span>
<span class="nt">e</span><span class="o">=&gt;</span><span class="nt">end</span><span class="o">:</span> <span class="err">结束</span><span class="o">(</span><span class="err">断开连接</span><span class="o">)</span>
<span class="nt">execmonkey</span><span class="o">=&gt;</span><span class="nt">operation</span><span class="o">:</span> <span class="err">发送指令打开</span><span class="nt">android</span><span class="err">设备上的服务</span><span class="o">(</span><span class="nt">monkey</span> <span class="nt">-port</span> <span class="nt">12345</span><span class="o">)</span>
<span class="nt">portforward</span><span class="o">=&gt;</span><span class="nt">operation</span><span class="o">:</span> <span class="err">把端口转发到</span><span class="nt">adb</span> <span class="nt">server</span><span class="err">上</span><span class="o">(</span><span class="nt">host-serial</span><span class="o">:$</span><span class="nt">SN</span><span class="nd">:forward:tcp:12345</span><span class="o">;</span><span class="nt">tcp</span><span class="nd">:12345</span><span class="o">)</span>
<span class="nt">connect</span><span class="o">=&gt;</span><span class="nt">operation</span><span class="o">:</span> <span class="err">连接到</span><span class="nt">monkey</span><span class="err">端口</span><span class="o">(</span><span class="nt">12345</span><span class="o">)</span>
<span class="nt">executecmd</span><span class="o">=&gt;</span><span class="nt">operation</span><span class="o">:</span> <span class="err">执行</span><span class="nt">monkey</span><span class="err">命令</span><span class="o">(</span><span class="nt">monkey</span><span class="err">命令都是以\</span><span class="nt">n</span><span class="err">结尾，而且一次连接可以执行多次命令</span><span class="o">)</span>
<span class="nt">st-</span><span class="o">&gt;</span><span class="nt">portforward-</span><span class="o">&gt;</span><span class="nt">execmonkey-</span><span class="o">&gt;</span><span class="nt">connect-</span><span class="o">&gt;</span><span class="nt">executecmd-</span><span class="o">&gt;</span><span class="nt">e</span>
</pre></div>


<h2><strong>socket层（TCP传输层）</strong></h2>
<h3><strong>增加传送monkey指令的功能</strong></h3>
<p>我们看一下socket层的代码是否需要我们自己添加</p>
<div class="highlight"><pre><span></span><span class="kt">char</span> <span class="o">*</span><span class="nf">adb_query</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">service</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="n">n</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span> <span class="c1">//+</span>

    <span class="n">D</span><span class="p">(</span><span class="s">&quot;adb_query: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">service</span><span class="p">);</span>
<span class="c1">//- int fd = adb_connect(service);</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">adb_connect</span><span class="p">(</span><span class="n">service</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__adb_error</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">readx</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="k">goto</span> <span class="n">oops</span><span class="p">;</span>
<span class="p">...</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">adb_connect</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">service</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// first query the adb server&#39;s version</span>
    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">_adb_connect</span><span class="p">(</span><span class="s">&quot;host:version&quot;</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;* daemon not running. *</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

        <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span><span class="s">&quot;* daemon not running. starting it now on port %d *</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="n">__adb_server_port</span><span class="p">);</span>
    <span class="nl">start_server</span><span class="p">:</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>


<p>adb client的命令有一部分是通过adb_query函数进行发送，里面会用到adb_connect，返回socket实例，再通过该socket读取到返回的内容进行输出</p>
<div class="highlight"><pre><span></span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="nf">adb_monkey_query</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">service</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mFd</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="n">n</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span> <span class="c1">//+</span>
    <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">outRel</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">D</span><span class="p">(</span><span class="s">&quot;adb_query: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">service</span><span class="p">);</span>
    <span class="c1">//- int fd = adb_connect(service);</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">_adb_monkey_connect</span><span class="p">(</span><span class="n">service</span><span class="p">,</span><span class="n">mFd</span><span class="p">,</span><span class="o">&amp;</span><span class="n">outRel</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__adb_error</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">outRel</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">adb_monkey_exec</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">service</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mFd</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="n">n</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span> <span class="c1">//+</span>
    <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">outRel</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">D</span><span class="p">(</span><span class="s">&quot;adb_query: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">service</span><span class="p">);</span>
    <span class="c1">//- int fd = adb_connect(service);</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">_adb_monkey_connect</span><span class="p">(</span><span class="n">service</span><span class="p">,</span><span class="n">mFd</span><span class="p">,</span><span class="o">&amp;</span><span class="n">outRel</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">outRel</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">free</span><span class="p">(</span><span class="n">outRel</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__adb_error</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">_adb_monkey_connect</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">service</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mFd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">**</span> <span class="n">outRel</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

    <span class="n">D</span><span class="p">(</span><span class="s">&quot;_adb_monkey_connect: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">service</span><span class="p">);</span>
    <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">service</span><span class="p">);</span>
    <span class="k">if</span><span class="p">((</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">__adb_error</span><span class="p">,</span> <span class="s">&quot;service name too long&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mFd</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">mFd</span> <span class="o">=</span> <span class="n">socket_loopback_client</span><span class="p">(</span><span class="n">__adb_monkey_server_port</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">mFd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">__adb_error</span><span class="p">,</span> <span class="s">&quot;cannot connect to monkey port&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">writex</span><span class="p">(</span><span class="n">mFd</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">__adb_error</span><span class="p">,</span> <span class="s">&quot;write monkey cmd failure during connection&quot;</span><span class="p">);</span>
        <span class="n">adb_close</span><span class="p">(</span><span class="n">mFd</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">adb_monkey_status</span><span class="p">(</span><span class="n">mFd</span><span class="p">,</span><span class="n">outRel</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">__adb_error</span><span class="p">,</span> <span class="s">&quot;monkey cmd return err&quot;</span><span class="p">);</span>
        <span class="c1">//adb_close(mFd);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">mFd</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>通过上面的代码可以看出，我增加了adb_monkey_query adb_monkey_exec 和 adb_monkey_connect，其实query和exec都是用到了connect函数，只是一个有返回，一个没有返回而已，底层adb_monkey_connect怎么实现的，其实和_adb_connect类似</p>
<div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">_adb_monkey_connect</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">service</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mFd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">**</span> <span class="n">outRel</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

    <span class="n">D</span><span class="p">(</span><span class="s">&quot;_adb_monkey_connect: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">service</span><span class="p">);</span>
    <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">service</span><span class="p">);</span>
    <span class="k">if</span><span class="p">((</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">__adb_error</span><span class="p">,</span> <span class="s">&quot;service name too long&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mFd</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">mFd</span> <span class="o">=</span> <span class="n">socket_loopback_client</span><span class="p">(</span><span class="n">__adb_monkey_server_port</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">mFd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">__adb_error</span><span class="p">,</span> <span class="s">&quot;cannot connect to monkey port&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">writex</span><span class="p">(</span><span class="n">mFd</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">__adb_error</span><span class="p">,</span> <span class="s">&quot;write monkey cmd failure during connection&quot;</span><span class="p">);</span>
        <span class="n">adb_close</span><span class="p">(</span><span class="n">mFd</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">adb_monkey_status</span><span class="p">(</span><span class="n">mFd</span><span class="p">,</span><span class="n">outRel</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">__adb_error</span><span class="p">,</span> <span class="s">&quot;monkey cmd return err&quot;</span><span class="p">);</span>
        <span class="c1">//adb_close(mFd);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">mFd</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">adb_monkey_status</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">**</span> <span class="n">rel</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">len</span><span class="p">,</span><span class="n">alllen</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">fail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="o">*</span><span class="n">rel</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="n">fd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">len</span> <span class="o">=</span> <span class="n">adb_read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">tbuf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span><span class="c1">//读取出错</span>
            <span class="n">fail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">tbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EINTR</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">alllen</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
        <span class="o">*</span><span class="n">rel</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">realloc</span><span class="p">(</span><span class="o">*</span><span class="n">rel</span><span class="p">,</span><span class="n">alllen</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="o">*</span><span class="n">rel</span><span class="o">+</span><span class="n">alllen</span><span class="o">-</span><span class="n">len</span><span class="p">,</span><span class="n">tbuf</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>
        <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">rel</span><span class="o">+</span><span class="n">alllen</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">fail</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">__adb_error</span><span class="p">,</span> <span class="s">&quot;monkey fault (no status)&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">rel</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">*</span><span class="n">rel</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>OK，整个monkey功能的socket层就算完了</p>
<h2><strong>应用层</strong></h2>
<h3><strong>adb.exe中无法传送utf-8格式字符串的问题</strong></h3>
<p>直接上代码，在执行命令的函数里面把buffer的编码变掉就可以</p>
<div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">shell</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">inSerial</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">inParams</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">**</span> <span class="n">outRelStr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">10240</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">rel</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">inParamsUTF8</span><span class="p">;</span>

    <span class="n">transport_type</span> <span class="n">ttype</span> <span class="o">=</span> <span class="n">kTransportAny</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">server_port</span> <span class="o">=</span> <span class="n">DEFAULT_ADB_PORT</span><span class="p">;</span>

    <span class="n">adb_set_transport</span><span class="p">(</span><span class="n">ttype</span><span class="p">,</span> <span class="n">inSerial</span><span class="p">);</span>
    <span class="n">adb_set_tcp_specifics</span><span class="p">(</span><span class="n">server_port</span><span class="p">);</span>

    <span class="c1">//这个函数就是关键的编码转换函数</span>
    <span class="n">GBK_to_UTF8</span><span class="p">(</span><span class="n">inParams</span><span class="p">,</span><span class="n">strlen</span><span class="p">(</span><span class="n">inParams</span><span class="p">),</span><span class="o">&amp;</span><span class="n">inParamsUTF8</span><span class="p">);</span>
    <span class="n">ZeroMemory</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="mi">10240</span><span class="p">);</span>
    <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span><span class="s">&quot;shell:%s&quot;</span><span class="p">,</span><span class="n">inParamsUTF8</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">inParamsUTF8</span><span class="p">);</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">adb_connect</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>  <span class="c1">//+</span>
    <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4096</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">alllen</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">while</span><span class="p">(</span><span class="n">fd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">len</span> <span class="o">=</span> <span class="n">adb_read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span><span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EINTR</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">alllen</span><span class="o">+=</span><span class="n">len</span><span class="p">;</span>
            <span class="n">rel</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">realloc</span><span class="p">(</span><span class="n">rel</span><span class="p">,</span><span class="n">alllen</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">rel</span><span class="o">+</span><span class="n">alllen</span><span class="o">-</span><span class="n">len</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>
            <span class="n">rel</span><span class="p">[</span><span class="n">alllen</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="c1">//先做调试用，后期去掉</span>
            <span class="c1">//fwrite(buf, 1, len, stdout);</span>
            <span class="c1">//fflush(stdout);</span>
        <span class="p">}</span>
        <span class="o">*</span> <span class="n">outRelStr</span> <span class="o">=</span> <span class="n">rel</span><span class="p">;</span>
        <span class="n">adb_close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>GBK_to_UTF8函数的代码不贴出来了，网上非常多</p>
<h3><strong>增加传送monkey指令的功能</strong></h3>
<div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">初始化monkey的连接，我们采用连接一次成功后，可以无限发送命令的模式</span>
<span class="cm">连接deviceSocket并查询版本信息</span>
<span class="cm">连接monkeySocket连接成功就行</span>
<span class="cm">返回：是否成功 1成功 0失败</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="nf">init</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">inSerial</span><span class="p">,</span> <span class="kt">int</span> <span class="n">inMonkeyPort</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">outMonkeySocket</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">transport_type</span> <span class="n">ttype</span> <span class="o">=</span> <span class="n">kTransportAny</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">server_port</span> <span class="o">=</span> <span class="n">DEFAULT_ADB_PORT</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">mrel</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4096</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">adb_trace_init</span><span class="p">();</span>
    <span class="n">adb_sysdeps_init</span><span class="p">();</span>

    <span class="c1">//这里只是设置一个模式，没有起实质性的变化</span>
    <span class="n">adb_set_transport</span><span class="p">(</span><span class="n">ttype</span><span class="p">,</span> <span class="n">inSerial</span><span class="p">);</span>
    <span class="n">adb_set_tcp_specifics</span><span class="p">(</span><span class="n">server_port</span><span class="p">);</span>

    <span class="c1">//打开Monkey的端口</span>
    <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="s">&quot;host-serial:%s:forward:tcp:%d;tcp:%d&quot;</span><span class="p">,</span><span class="n">inSerial</span><span class="p">,</span><span class="n">inMonkeyPort</span><span class="p">,</span><span class="n">inMonkeyPort</span><span class="p">);</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">adb_connect</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">adb_status</span><span class="p">(</span><span class="n">fd</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">adb_close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">read_finished</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
        <span class="n">adb_close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adb_error</span><span class="p">());</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//把手机端的Monkey端口设置为我们的端口</span>
    <span class="c1">//这是一个bug貌似，非常低端... monkey是阻塞命令，如果连接成功之后直接close这样monkey程序就会退出，所以睡5秒再说，官方的方法就是睡的5秒，如果有更好的办法就太好了</span>
    <span class="n">set_monkey_port</span><span class="p">(</span><span class="n">inMonkeyPort</span><span class="p">);</span>
    <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="s">&quot;shell:monkey --port %d&quot;</span><span class="p">,</span> <span class="n">inMonkeyPort</span><span class="p">);</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">adb_connect</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;monkey --port %d done</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">inMonkeyPort</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Sleep</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>
        <span class="n">adb_close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;monkey --port %d ok</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">inMonkeyPort</span><span class="p">);</span>

    <span class="c1">//唤醒屏幕</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;wake</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
    <span class="o">*</span><span class="n">outMonkeySocket</span> <span class="o">=</span> <span class="n">_adb_monkey_connect</span><span class="p">(</span> <span class="s">&quot;wake</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">&amp;</span><span class="n">mrel</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mrel</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">free</span><span class="p">(</span><span class="n">mrel</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">outMonkeySocket</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">get_adb_error</span><span class="p">());</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>下面例举几个monkey的应用层命令</p>
<div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">wake</span><span class="p">(</span><span class="kt">int</span> <span class="n">inMonkeySocket</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">adb_monkey_exec</span><span class="p">(</span><span class="s">&quot;wake</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">inMonkeySocket</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">press</span><span class="p">(</span><span class="kt">int</span> <span class="n">inMonkeySocket</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">inKeyName</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">intPressType</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4096</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;down&quot;</span><span class="p">,</span><span class="n">intPressType</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="s">&quot;down&quot;</span><span class="p">))</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span><span class="s">&quot;key down %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">inKeyName</span><span class="p">);</span>
    <span class="p">}</span> 
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;up&quot;</span><span class="p">,</span><span class="n">intPressType</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="s">&quot;up&quot;</span><span class="p">))</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span><span class="s">&quot;key up %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">inKeyName</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;downAndUp&quot;</span><span class="p">,</span><span class="n">intPressType</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="s">&quot;downAndUp&quot;</span><span class="p">))</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span><span class="s">&quot;press %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">inKeyName</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">adb_monkey_exec</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">inMonkeySocket</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>OK，先分析思路，再搭建底层，最后建立应用层，整个adb.exe，或者adb.dll其他的，就可以操控整个android系统了，非常实用。下一讲讲啥呢？操控是可以，我要根据android设备的屏幕输出判断程序结果是否正确怎么办？怎么获取图像？怎么辨别？</p>
            </div>
            <!-- /.entry-content -->
<section class="well" id="related-posts">
    <h4>Related Posts:</h4>
    <ul>
        <li><a href="/get-screen-from-android-dev.html">从Android设备获取实时截屏(adb)</a></li>
        <li><a href="/android-adb-talk.html">Android Adb调试功能漫谈</a></li>
        <li><a href="/how-to-be-data-driven-cop.html">[译]如何（为什么）成为一家数据驱动型的公司？</a></li>
        <li><a href="/train-for-scrum.html">我的一次敏捷培训</a></li>
        <li><a href="/make-android-to-hifi.html">Android手机能变Hifi播放器？</a></li>
    </ul>
</section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Social -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
  <ul class="list-group" id="social">
    <li class="list-group-item"><a href="https://github.com/mhxueshan"><i class="fa fa-github-square fa-lg"></i> Github</a></li>
  </ul>
</li>
<!-- End Sidebar/Social -->

<!-- Sidebar/Tag Cloud -->
<li class="list-group-item">
  <a href="/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
  <ul class="list-group list-inline tagcloud" id="tags">
    <li class="list-group-item tag-2">
      <a href="/tag/adb.html">adb</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="/tag/android.html">Android</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="/tag/can-shu-you-hua.html">参数优化</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="/tag/cheng-shou-zhi-biao.html">成熟指标</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="/tag/chi-cang-liang.html">持仓量</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="/tag/elite3.html">Elite3</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="/tag/gai-lu.html">概率</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="/tag/gu-piao.html">股票</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="/tag/hifi.html">hifi</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="/tag/ji-qi-xue-xi.html">机器学习</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="/tag/ji-zhu.html">技术</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="/tag/lai-ci-gou.html">莱茨狗</a>
    </li>
    <li class="list-group-item tag-1">
      <a href="/tag/liang-hua.html">量化</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="/tag/lu-you-qi.html">路由器</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="/tag/mongodb.html">mongodb</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="/tag/monkey.html">monkey</a>
    </li>
    <li class="list-group-item tag-1">
      <a href="/tag/ri-chang.html">日常</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="/tag/shi-jian-xu-lie.html">时间序列</a>
    </li>
    <li class="list-group-item tag-3">
      <a href="/tag/shu-xue.html">数学</a>
    </li>
    <li class="list-group-item tag-3">
      <a href="/tag/tong-ji.html">统计</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="/tag/xin-li-xue.html">心理学</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="/tag/yi-chuan-suan-fa.html">遗传算法</a>
    </li>
    <li class="list-group-item tag-3">
      <a href="/tag/yi-wen.html">译文</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="/tag/yu-le.html">娱乐</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="/tag/za-tan.html">杂谈</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Tag Cloud -->

<!-- Sidebar/Links -->
<li class="list-group-item">
  <h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
  <ul class="list-group" id="links">
    <li class="list-group-item">
      <a href="http://makerchen.com" target="_blank">MakerChen</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Links -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2019 雪山
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="/theme/js/respond.min.js"></script>



</body>
</html>